<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>極致星盤 - 專業占星計算器</title>
    <link rel="stylesheet" href="style.css">
    <!-- Scripts loaded sequentially for non-module usage -->
    <script src="astro-data.js"></script>
    <script src="astro-core.js"></script>
    <script src="ziwei-core.js"></script>
    <script src="astro-chart.js"></script>
</head>

<body>

    <main>
        <div class="sidebar">
            <section class="card">
                <div class="form-group">
                    <label for="birth-date">出生日期</label>
                    <input type="date" id="birth-date" value="1995-01-01">
                </div>
                <div class="form-group">
                    <label>出生時間</label>
                    <div style="display: flex; gap: 0.5rem;">
                        <select id="birth-hour" style="flex: 1;">
                            <!-- Hours 0-23 will be injected -->
                        </select>
                        <select id="birth-minute" style="flex: 1;">
                            <!-- Minutes 0-59 will be injected -->
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label style="display: flex; align-items: center; cursor: pointer;">
                        <input type="checkbox" id="manual-coords-toggle" style="width: auto; margin-right: 0.5rem;">
                        <span>手動輸入經緯度</span>
                    </label>
                </div>
                <div id="location-presets" class="form-group">
                    <label>出生地點 (台灣)</label>
                    <div style="display: flex; gap: 0.5rem; margin-bottom: 0.5rem;">
                        <select id="location-city" style="flex: 1;">
                            <option value="">選擇縣市</option>
                        </select>
                        <select id="location-district" style="flex: 1;">
                            <option value="">選擇行政區</option>
                        </select>
                    </div>
                </div>
                <div id="manual-coords-inputs" class="form-group" style="display: none; gap: 0.5rem;">
                    <div style="flex: 1;">
                        <label>經度 (Longitude)</label>
                        <input type="number" id="manual-lon" step="0.01" value="121.56">
                    </div>
                    <div style="flex: 1;">
                        <label>緯度 (Latitude)</label>
                        <input type="number" id="manual-lat" step="0.01" value="25.03">
                    </div>
                </div>
                <div class="form-group"
                    style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--glass-border);">
                    <div
                        style="display: flex; align-items: center; margin-bottom: 0.5rem; justify-content: space-between;">
                        <span style="color: #69ff8c; font-weight: bold;">行運星盤設定 (Transit)</span>
                        <button id="transit-info-btn"
                            style="background:none; border:1px solid var(--text-dim); border-radius:50%; width:20px; height:20px; color: var(--text-dim); cursor: pointer; font-size: 0.8rem; display: flex; align-items: center; justify-content: center;">?</button>
                    </div>
                    <button id="sync-now-btn"
                        style="width: 100%; margin-bottom: 0.8rem; padding: 0.4rem; font-size: 0.8rem; background: rgba(105, 255, 140, 0.1); color: #69ff8c; border: 1px solid rgba(105, 255, 140, 0.3); border-radius: 4px; cursor: pointer;">
                        同步目前時間 (Sync Now)
                    </button>
                    <div id="transit-controls">
                        <label>行運日期 (預設今日)</label>
                        <input type="date" id="transit-date">
                        <label style="margin-top: 0.5rem;">行運時間</label>
                        <div style="display: flex; gap: 0.5rem;">
                            <select id="transit-hour" style="flex: 1;"></select>
                            <select id="transit-minute" style="flex: 1;"></select>
                        </div>
                    </div>
                </div>

                <button id="calculate-btn">生成星盤</button>
                <button id="export-btn"
                    style="margin-top: 1rem; background: rgba(255,255,255,0.1); color: var(--text-gold); border: 1px solid var(--primary); font-size: 0.9rem; padding: 0.8rem;">匯出星盤圖片
                    (PNG)</button>
            </section>

            <section class="card" id="house-system-info">
                <h3 style="color: var(--text-gold); margin-bottom: 0.5rem; font-size: 1rem;">計算設定</h3>
                <div class="form-group">
                    <label>分宮制 (House System)</label>
                    <select id="house-system-select">
                        <option value="placidus">普拉西度 (Placidus)</option>
                        <option value="whole">整宮制 (Whole Sign)</option>
                        <option value="equal">等宮制 (Equal House)</option>
                    </select>
                </div>
                <p style="font-size: 0.85rem; color: var(--text-dim); margin-top: 0.5rem;">
                    座標系統：回歸黃道 (Tropical)<br>
                    時區：UTC+8 (台灣標準時間)
                </p>
                <button id="download-json-btn"
                    style="margin-top: 1.5rem; padding: 0.6rem; font-size: 0.75rem; background: rgba(255,255,255,0.05); color: var(--text-dim); border: 1px solid var(--glass-border);">
                    匯出歷史紀錄 (JSON)
                </button>
            </section>

            <section class="card" id="recent-history-card">
                <h3 style="color: var(--text-gold); margin-bottom: 0.5rem; font-size: 1rem;">最近紀錄</h3>
                <div id="history-list" class="history-list">
                    <!-- History items will be injected here -->
                </div>
            </section>
        </div>

        </div>

        <div style="flex-grow: 1; display: flex; flex-direction: column; gap: 2rem;">
            <div class="chart-container">
                <svg id="chart-svg" viewBox="0 0 600 600">
                    <!-- Background Circles -->
                    <circle cx="300" cy="300" r="280" fill="none" stroke="rgba(201, 160, 80, 0.2)" stroke-width="1" />
                    <circle cx="300" cy="300" r="250" fill="none" stroke="rgba(201, 160, 80, 0.4)" stroke-width="2" />
                    <circle cx="300" cy="300" r="150" fill="none" stroke="rgba(201, 160, 80, 0.2)" stroke-width="1" />

                    <!-- Dynamic Content will be injected here -->
                    <g id="zodiac-ring"></g>
                    <g id="houses-layer"></g>
                    <g id="aspects-layer"></g>
                    <g id="planets-layer"></g>
                    <g id="transit-layer" style="display: none;"></g>

                    <!-- Center points -->
                    <circle cx="300" cy="300" r="4" fill="var(--primary)" />
                </svg>
            </div>

            <!-- Analysis Dashboard (Moved from Sidebar) -->
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem;">
                <section class="card" id="precision-diagnostic-card" style="height: 100%;">
                    <h3 style="color: var(--text-gold); margin-bottom: 1rem; font-size: 1rem;">半球與象限分析</h3>
                    <div id="precision-diagnostic">
                        <!-- Diagnostic info will be injected here -->
                    </div>
                </section>

                <section class="card" id="balance-analysis-card" style="height: 100%;">
                    <h3 style="color: var(--text-gold); margin-bottom: 1rem; font-size: 1rem;">元素能量分析</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
                        <div class="balance-group" id="elements-chart">
                            <!-- Injected JS -->
                        </div>
                        <div class="balance-group" id="modalities-chart">
                            <!-- Injected JS -->
                        </div>
                    </div>
                </section>
            </div>

            <!-- Transit Results Panel (Added) -->
            <div class="results-panel" id="transit-results-list" style="margin-top: 1.5rem; display: none;">
                <div
                    style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1rem; border-bottom: 1px solid rgba(105, 255, 140, 0.3); padding-bottom: 0.5rem;">
                    <span style="font-size: 1.2rem;">✨</span>
                    <h3 style="color: #69ff8c; margin: 0;">行運天象位置 (Transit Positions)</h3>
                </div>
                <div id="transit-items-container"
                    style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 1rem;">
                </div>
            </div>



            <div class="results-panel" id="results-list">
                <!-- Results will be injected here -->
            </div>

            <div class="aspects-table-container">
                <h3>相位列表 (Aspects)</h3>
                <div class="aspect-grid" id="aspect-list">
                    <!-- Aspects will be injected here -->
                </div>
            </div>

            <!-- Zi Wei Dou Shu Panel (Moved to Bottom) -->
            <div class="results-panel" id="ziwei-results-list" style="margin-top: 2rem; grid-column: 1 / -1;">
                <div
                    style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1rem; border-bottom: 1px solid rgba(157, 105, 255, 0.3); padding-bottom: 0.5rem;">
                    <span style="font-size: 1.2rem;">🔮</span>
                    <h3 style="color: #bc8cff; margin: 0;">紫微斗數命盤 (Zi Wei Dou Shu)</h3>
                </div>

                <div class="ziwei-grid-layout" id="ziwei-grid">
                    <div class="ziwei-cell c-si" id="palace-si" data-b="si"></div>
                    <div class="ziwei-cell c-wu" id="palace-wu" data-b="wu"></div>
                    <div class="ziwei-cell c-wei" id="palace-wei" data-b="wei"></div>
                    <div class="ziwei-cell c-shen" id="palace-shen" data-b="shen"></div>

                    <div class="ziwei-cell c-chen" id="palace-chen" data-b="chen"></div>
                    <div class="ziwei-center">
                    </div>
                    <div class="ziwei-cell c-you" id="palace-you" data-b="you"></div>

                    <div class="ziwei-cell c-mao" id="palace-mao" data-b="mao"></div>
                    <div class="ziwei-cell c-xu" id="palace-xu" data-b="xu"></div>

                    <div class="ziwei-cell c-yin" id="palace-yin" data-b="yin"></div>
                    <div class="ziwei-cell c-chou" id="palace-chou" data-b="chou"></div>
                    <div class="ziwei-cell c-zi" id="palace-zi" data-b="zi"></div>
                    <div class="ziwei-cell c-hai" id="palace-hai" data-b="hai"></div>
                </div>
            </div>
    </main>

    <div class="loading-overlay" id="loading">
        <div style="text-align: center;">
            <div style="font-size: 2rem; color: var(--primary); margin-bottom: 1rem;">正在觀測星象...</div>
            <div style="color: var(--text-dim);">計算行星位置與宮位中</div>
        </div>
    </div>

    <!-- Interpretation Modal -->
    <div class="modal-overlay" id="modal-overlay">
        <div class="modal-content">
            <button class="modal-close" id="modal-close">&times;</button>
            <div class="modal-header">
                <div class="icon" id="modal-icon">☉</div>
                <div>
                    <h2 id="modal-title">太陽</h2>
                    <div class="subtitle" id="modal-subtitle">SUN IN ARIES</div>
                </div>
            </div>
            <div class="interpretation-text">
                <div class="interpretation-section">
                    <h3 id="modal-point-label">行星能量</h3>
                    <p id="modal-planet-meaning">代表核心人格與生命力。</p>
                </div>
                <div class="interpretation-section">
                    <h3 id="modal-sign-label">星座表現</h3>
                    <p id="modal-sign-meaning">在這星座展現出勇往直前的特質。</p>
                </div>
                <div class="interpretation-section">
                    <h3 id="modal-combine-label">綜合解讀</h3>
                    <p id="modal-combined-meaning">您的核心人格充滿活力且熱愛挑戰。</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Logic -->
    <script src="app.js"></script>
</body>

</html>